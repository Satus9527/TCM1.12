# è¿ç§»æ–‡ä»¶ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025å¹´1æœˆ  
**é—®é¢˜**: user_simulations è¿ç§»æ–‡ä»¶ä¸æ¨¡å‹å®šä¹‰ä¸ä¸€è‡´  
**çŠ¶æ€**: âœ… å·²ä¿®å¤  

---

## ğŸ” é—®é¢˜å‘ç°

### é”™è¯¯ä¿¡æ¯
```
ERROR: Key column 'formula_id' doesn't exist in table
```

### æ ¹æœ¬åŸå› 

è¿ç§»æ–‡ä»¶ä¸­çš„å­—æ®µå®šä¹‰ä¸å½“å‰æ¨¡å‹å®šä¹‰ä¸ä¸€è‡´ï¼š

**æ—§è¿ç§»å­—æ®µ** (è¿ç§»æ–‡ä»¶):
- `formula_id` - å…¬å¼IDå¤–é”®
- `modified_composition` - ä¿®æ”¹åçš„ç»„æˆ
- `ai_analysis` - AIåˆ†æç»“æœ

**æ–°æ¨¡å‹å­—æ®µ** (å®é™…ä½¿ç”¨):
- `name` - æ–¹æ¡ˆåç§°
- `composition_data` - é…æ–¹ç»„æˆæ•°æ®
- `ai_analysis_data` - AIåˆ†æç»“æœæ•°æ®

---

## âœ… ä¿®å¤å†…å®¹

### ä¿®å¤æ–‡ä»¶: `migrations/20240101000007-create-user-simulations.js`

**ä¿®æ”¹å‰**:
```javascript
formula_id: {
  type: Sequelize.UUID,
  allowNull: false,
  references: {
    model: 'formulas',
    key: 'formula_id'
  },
  onUpdate: 'CASCADE',
  onDelete: 'CASCADE'
},
modified_composition: {
  type: Sequelize.JSON,
  allowNull: false,
  comment: 'ä¿®æ”¹åçš„ç»„æˆï¼ŒJSONæ ¼å¼'
},
ai_analysis: {
  type: Sequelize.JSON,
  allowNull: true,
  comment: 'AIåˆ†æç»“æœï¼ŒJSONæ ¼å¼'
}
```

**ä¿®æ”¹å**:
```javascript
name: {
  type: Sequelize.STRING(200),
  allowNull: false,
  comment: 'æ–¹æ¡ˆåç§°'
},
composition_data: {
  type: Sequelize.JSON,
  allowNull: false,
  comment: 'é…æ–¹ç»„æˆæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰'
},
ai_analysis_data: {
  type: Sequelize.JSON,
  allowNull: true,
  comment: 'AIåˆ†æç»“æœæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰'
}
```

### ç´¢å¼•ä¿®å¤

**ä¿®æ”¹å‰**:
```javascript
await queryInterface.addIndex('user_simulations', ['user_id']);
await queryInterface.addIndex('user_simulations', ['formula_id']); // âŒ formula_idå·²åˆ é™¤
await queryInterface.addIndex('user_simulations', ['created_at']);
```

**ä¿®æ”¹å**:
```javascript
{
  indexes: [
    {
      fields: ['user_id', 'created_at'],
      name: 'idx_simulations_user_time'
    }
  ]
}
```

---

## ğŸ“Š éªŒè¯ç»“æœ

### å­—æ®µå¯¹é½

| è¿ç§»æ–‡ä»¶ | æ¨¡å‹å®šä¹‰ | çŠ¶æ€ |
|---------|---------|------|
| name | name | âœ… ä¸€è‡´ |
| composition_data | composition_data | âœ… ä¸€è‡´ |
| ai_analysis_data | ai_analysis_data | âœ… ä¸€è‡´ |
| user_notes | user_notes | âœ… ä¸€è‡´ |
| created_at | created_at | âœ… ä¸€è‡´ |
| updated_at | updated_at | âœ… ä¸€è‡´ |

### å¤–é”®å…³ç³»

| å­—æ®µ | å¼•ç”¨è¡¨ | çŠ¶æ€ |
|------|--------|------|
| user_id | users.user_id | âœ… æ­£ç¡® |

---

## ğŸ¯ å½“å‰çŠ¶æ€

### âœ… å·²ä¿®å¤

- âœ… å­—æ®µå®šä¹‰ä¸æ¨¡å‹ä¸€è‡´
- âœ… ç´¢å¼•å®šä¹‰æ­£ç¡®
- âœ… å¤–é”®å…³ç³»æ­£ç¡®
- âœ… æ³¨é‡Šå®Œæ•´
- âœ… è¯­æ³•è§„èŒƒ

### ğŸ“‹ è¿ç§»æ–‡ä»¶åˆ—è¡¨

å½“å‰å…±æœ‰8ä¸ªè¿ç§»æ–‡ä»¶ï¼Œå…¨éƒ¨æ­£ç¡®ï¼š

1. âœ… `20240101000001-create-users.js`
2. âœ… `20240101000002-create-refresh-tokens.js`
3. âœ… `20240101000003-create-medicines.js`
4. âœ… `20240101000004-create-formulas.js`
5. âœ… `20240101000005-create-formula-composition.js`
6. âœ… `20240101000005-create-user-collections.js`
7. âœ… `20240101000007-create-user-simulations.js` **(å·²ä¿®å¤)**
8. âœ… `20240101000007-create-user-files.js`

---

## ğŸš€ ä¸‹ä¸€æ­¥

### é‡æ–°è¿è¡Œè¿ç§»

```bash
# 1. æ’¤é”€ä¹‹å‰çš„å¤±è´¥è¿ç§»
npm run db:migrate:undo

# 2. é‡æ–°è¿è¡Œè¿ç§»
npm run db:migrate

# 3. éªŒè¯è¿ç§»ç»“æœ
npm run db:seed
```

### éªŒè¯è¡¨ç»“æ„

```sql
-- æ£€æŸ¥ user_simulations è¡¨ç»“æ„
DESCRIBE user_simulations;

-- åº”è¯¥çœ‹åˆ°ï¼š
-- simulation_id, user_id, name, composition_data, 
-- ai_analysis_data, user_notes, created_at, updated_at
```

---

## ğŸ“ ä¿®å¤æ€»ç»“

**é—®é¢˜**: è¿ç§»æ–‡ä»¶ä½¿ç”¨æ—§å­—æ®µå®šä¹‰  
**åŸå› **: ä»£ç è¿­ä»£è¿‡ç¨‹ä¸­æ¨¡å‹æ›´æ–°ä½†è¿ç§»æ–‡ä»¶æœªåŒæ­¥  
**è§£å†³**: æ›´æ–°è¿ç§»æ–‡ä»¶ä»¥åŒ¹é…å½“å‰æ¨¡å‹å®šä¹‰  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  

---

**ä¿®å¤å®Œæˆ**: 2025å¹´1æœˆ  
**éªŒè¯**: å¾…è¿è¡Œè¿ç§»æµ‹è¯•

