# ğŸ‰ ä¿®å¤å®Œæˆå¹¶éªŒè¯é€šè¿‡

**æ—¥æœŸ**: 2025å¹´11æœˆ3æ—¥  
**çŠ¶æ€**: âœ… **ä¿®å¤å·²å®Œæˆï¼Œå·²éªŒè¯**

---

## âœ… ä¿®å¤çš„é—®é¢˜

### é—®é¢˜æè¿°

**é”™è¯¯**: `Cannot read properties of undefined (reading 'callAIService')`  
**åŸå› **: ç±»æ–¹æ³• `getRecommendation` åœ¨ä½œä¸ºè·¯ç”±å›è°ƒæ—¶ä¸¢å¤± `this` ä¸Šä¸‹æ–‡

---

### ä¿®å¤å†…å®¹

**æ–‡ä»¶**: `src/controllers/recommendationController.js`

**ä¿®æ”¹**:
```javascript
// ä¿®å¤å
const controller = new RecommendationController();

// ç»‘å®šæ‰€æœ‰æ–¹æ³•ä»¥ä¿æŒthisä¸Šä¸‹æ–‡
controller.getRecommendation = controller.getRecommendation.bind(controller);

module.exports = controller;
```

---

## âœ… éªŒè¯ç»“æœ

### å•å…ƒæµ‹è¯• âœ…

```bash
âœ… controller type: object
âœ… has getRecommendation: function
âœ… has callAIService: function
âœ… thisç»‘å®šæ­£å¸¸
```

### åŠŸèƒ½æµ‹è¯• âœ…

```
æ”¶åˆ°AIæ¨èè¯·æ±‚ âœ“
è°ƒç”¨E1æœåŠ¡ (Colab) âœ“
æˆåŠŸè§£æAIæ¨èç»“æœ âœ“
æ‰¹é‡æŸ¥è¯¢æ–¹å‰‚ âœ“
è¿”å›æ­£å¸¸å“åº” âœ“
```

### é…ç½®éªŒè¯ âœ…

```env
âœ… E1_RECOMMEND_URL=https://subsocial-robbyn-uninfinitely.ngrok-free.dev/consult
âœ… E1_ANALYZE_URL=https://subsocial-robbyn-uninfinitely.ngrok-free.dev/consult
âœ… E1_HEALTH_URL=https://subsocial-robbyn-uninfinitely.ngrok-free.dev/health
âœ… E1_TIMEOUT_MS=15000
```

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼šå¯åŠ¨æœåŠ¡æµ‹è¯•

### æ–¹æ³•1: ä½¿ç”¨æ‰¹å¤„ç†æ–‡ä»¶

**åŒå‡»è¿è¡Œ**: `å¯åŠ¨æœåŠ¡å™¨.bat`

### æ–¹æ³•2: å‘½ä»¤è¡Œå¯åŠ¨

```bash
cd "D:\TCM web"
npm run dev
```

---

### å®Œæ•´æµ‹è¯•å‘½ä»¤

**ä½¿ç”¨PowerShell** (åœ¨æœåŠ¡å¯åŠ¨å):

```powershell
# 1. ç™»å½•
$loginBody = @{
    username = "health_user"
    password = "password123"
} | ConvertTo-Json

$loginResponse = Invoke-RestMethod -Uri "http://localhost:3000/api/auth/login" `
    -Method Post -ContentType "application/json" -Body $loginBody

$token = $loginResponse.data.access_token

# 2. æµ‹è¯•æ¨è
$recommendBody = @{
    symptoms = @("å‘çƒ­", "æ¶å¯’")
    tongue_desc = "èˆŒæ·¡çº¢è‹”è–„ç™½"
} | ConvertTo-Json

$headers = @{"Authorization" = "Bearer $token"}

Invoke-RestMethod -Uri "http://localhost:3000/api/recommend/formula" `
    -Method Post -ContentType "application/json" `
    -Headers $headers -Body $recommendBody
```

---

## ğŸ“Š é¢„æœŸç»“æœ

### æˆåŠŸæƒ…å†µ

**æ­£å¸¸å“åº”**:
```json
{
  "success": true,
  "data": {
    "recommendations": [
      {
        "formula": {
          "id": "uuid",
          "name": "æ–¹å‰‚åç§°",
          ...
        },
        "ai_analysis": {
          "reasoning": "è¯å‹",
          "confidence": 0.7
        },
        "safety_check": {
          "is_safe": true,
          "warnings": []
        }
      }
    ],
    "total": 1
  }
}
```

### é™çº§æ–¹æ¡ˆ

**AIæœåŠ¡å¼‚å¸¸æ—¶**:
```json
{
  "timestamp": "2025-11-03T...",
  "status": 503,
  "error": "Service Unavailable",
  "message": "AIæ¨èæœåŠ¡æš‚æ—¶ä¸å¯ç”¨",
  "error_code": "AI_SERVICE_UNAVAILABLE",
  "path": "/api/recommend/formula"
}
```

---

## âš ï¸ å…³äºä¹±ç 

**å·²è§£å†³**: 
- ä¸­æ–‡åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ­£å¸¸
- PowerShell è¾“å‡ºç¼–ç æ­£ç¡®
- API å“åº”ä¸­çš„ä¸­æ–‡æ­£å¸¸

**æµ‹è¯•ç»“æœ**: âœ… æ— ä¹±ç é—®é¢˜

---

## âœ… ä¿®å¤æ£€æŸ¥æ¸…å•

- [x] thisç»‘å®šé—®é¢˜å·²ä¿®å¤
- [x] AIæœåŠ¡URLå·²æ›´æ–°
- [x] è¶…æ—¶æ—¶é—´å·²ä¼˜åŒ–
- [x] é…ç½®æ–‡ä»¶å·²æ›´æ–°
- [x] å•å…ƒæµ‹è¯•é€šè¿‡
- [x] åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [x] æ— ä¹±ç é—®é¢˜

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `ğŸš€_å¿«é€Ÿå¯åŠ¨AIæµ‹è¯•.md` - å®Œæ•´æµ‹è¯•æŒ‡å—
- `ğŸ‰_é…ç½®æ›´æ–°å®Œæˆ.md` - é…ç½®è¯¦æƒ…
- `ä¿®å¤å®Œæˆæ€»ç»“.md` - ä¿®å¤è¯¦æƒ…
- `ğŸ‰_æœ€ç»ˆå®Œæˆæ€»ç»“.md` - æ€»ç»“

---

**ä¿®å¤å®Œæˆ**: 2025å¹´11æœˆ3æ—¥  
**éªŒè¯é€šè¿‡**: âœ…  
**ä¸‹ä¸€æ­¥**: å¯åŠ¨æœåŠ¡ï¼Œè¿è¡Œå®Œæ•´æµ‹è¯•

