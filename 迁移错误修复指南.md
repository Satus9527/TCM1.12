# è¿ç§»é”™è¯¯ä¿®å¤æŒ‡å—

**é—®é¢˜**: æ•°æ®åº“è¿ç§»å¤±è´¥ - `content_type` åˆ—ç´¢å¼•åˆ›å»ºé”™è¯¯

**åŸå› **: Sequelize è¿ç§»æ–‡ä»¶ä¸­ï¼Œç´¢å¼•å®šä¹‰æ–¹å¼ä¸æ­£ç¡®

**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ”§ å¿«é€Ÿä¿®å¤æ­¥éª¤

### 1ï¸âƒ£ å›æ»šå¤±è´¥çš„è¿ç§»
```bash
cd "D:\TCM web"
npx sequelize-cli db:migrate:undo
```

**è¯´æ˜**: è¿™ä¼šæ’¤é”€æœ€åä¸€æ¬¡è¿ç§»ï¼ˆå¦‚æœè¿ç§»è¡¨è®°å½•äº†çš„è¯ï¼‰

---

### 2ï¸âƒ£ æ‰‹åŠ¨æ¸…ç†æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœå›æ»šå‘½ä»¤ä¸èµ·ä½œç”¨ï¼Œéœ€è¦æ‰‹åŠ¨åˆ é™¤è¡¨ï¼š

```sql
-- åœ¨ MySQL å‘½ä»¤è¡Œæˆ– Workbench ä¸­æ‰§è¡Œ
USE tcm_platform;

-- åˆ é™¤å¯èƒ½å·²åˆ›å»ºçš„è¡¨ï¼ˆæŒ‰é¡ºåºï¼Œå…ˆåˆ é™¤æœ‰å¤–é”®çš„è¡¨ï¼‰
DROP TABLE IF EXISTS user_collections;
DROP TABLE IF EXISTS user_simulations;
DROP TABLE IF EXISTS user_files;
```

---

### 3ï¸âƒ£ é‡æ–°è¿è¡Œè¿ç§»
```bash
npx sequelize-cli db:migrate
```

**é¢„æœŸè¾“å‡º**:
```
Sequelize CLI [Node: xx.x.x, CLI: x.x.x, ORM: x.x.x]

Loaded configuration file "config/database.js".
Using environment "development".
== 20240101000005-create-user-collections: migrating =======
== 20240101000005-create-user-collections: migrated (0.XXXs)

== 20240101000006-create-user-simulations: migrating =======
== 20240101000006-create-user-simulations: migrated (0.XXXs)

== 20240101000007-create-user-files: migrating =======
== 20240101000007-create-user-files: migrated (0.XXXs)
```

---

### 4ï¸âƒ£ éªŒè¯è¡¨åˆ›å»º
```bash
# åœ¨ PowerShell ä¸­æ‰§è¡Œ
mysql -u root -p -e "USE tcm_platform; SHOW TABLES;"
```

**é¢„æœŸçœ‹åˆ°**:
```
+-------------------------+
| Tables_in_tcm_platform  |
+-------------------------+
| formulas                |
| formula_compositions    |
| medicines               |
| refresh_tokens          |
| SequelizeMeta           |
| user_collections        | â† æ–°è¡¨
| user_files              | â† æ–°è¡¨
| user_simulations        | â† æ–°è¡¨
| users                   |
+-------------------------+
```

---

### 5ï¸âƒ£ éªŒè¯ç´¢å¼•åˆ›å»º
```sql
-- æŸ¥çœ‹ user_collections è¡¨ç»“æ„å’Œç´¢å¼•
SHOW CREATE TABLE user_collections;

-- æˆ–è€…æŸ¥çœ‹ç´¢å¼•
SHOW INDEX FROM user_collections;
```

**é¢„æœŸç´¢å¼•**:
- `PRIMARY` (collection_id)
- `unique_user_collection` (user_id, content_type, content_id) - **UNIQUE**
- `idx_user_collections_user_id` (user_id)
- `user_id` (å¤–é”®ç´¢å¼•)

---

## ğŸ“ ä¿®å¤å†…å®¹

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`migrations/20240101000005-create-user-collections.js`**
   - å°†ç´¢å¼•å®šä¹‰ä» `addIndex()` æ–¹æ³•æ”¹ä¸º `createTable()` çš„ `indexes` é€‰é¡¹

2. **`migrations/20240101000006-create-user-simulations.js`**
   - åŒæ ·çš„ä¿®å¤

3. **`migrations/20240101000007-create-user-files.js`**
   - åŒæ ·çš„ä¿®å¤

### ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰:
```javascript
await queryInterface.createTable('user_collections', { ... });

// åˆ†ç¦»çš„ç´¢å¼•åˆ›å»ºï¼ˆä¼šå¯¼è‡´é”™è¯¯ï¼‰
await queryInterface.addIndex('user_collections', [...], { ... });
```

### ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰:
```javascript
await queryInterface.createTable('user_collections', {
  // ... åˆ—å®šä¹‰ ...
}, {
  // åœ¨ createTable é€‰é¡¹ä¸­ç›´æ¥å®šä¹‰ç´¢å¼•
  indexes: [
    {
      unique: true,
      fields: ['user_id', 'content_type', 'content_id'],
      name: 'unique_user_collection'
    }
  ]
});
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å›æ»šå‘½ä»¤æŠ¥é”™ "No migrations were executed, database schema was already up to date"
**è§£å†³**: è¯´æ˜ Sequelize æ²¡æœ‰è®°å½•è¿™æ¬¡å¤±è´¥çš„è¿ç§»ã€‚ç›´æ¥æ‰§è¡Œæ­¥éª¤2æ‰‹åŠ¨æ¸…ç†ã€‚

### Q2: æ‰‹åŠ¨åˆ é™¤è¡¨æ—¶æŠ¥é”™ "Cannot drop table 'xxx' referenced by a foreign key"
**è§£å†³**: æŒ‰ç…§æ­£ç¡®çš„é¡ºåºåˆ é™¤è¡¨ï¼ˆå…ˆåˆ é™¤æœ‰å¤–é”®çš„å­è¡¨ï¼‰:
```sql
DROP TABLE IF EXISTS user_collections;
DROP TABLE IF EXISTS user_simulations;
DROP TABLE IF EXISTS user_files;
```

### Q3: è¿ç§»æˆåŠŸä½†çœ‹ä¸åˆ°è¡¨
**è§£å†³**: æ£€æŸ¥æ˜¯å¦è¿æ¥åˆ°æ­£ç¡®çš„æ•°æ®åº“:
```sql
SELECT DATABASE();  -- æŸ¥çœ‹å½“å‰æ•°æ®åº“
USE tcm_platform;   -- åˆ‡æ¢åˆ°æ­£ç¡®çš„æ•°æ®åº“
```

### Q4: ENUM ç±»å‹æ˜¾ç¤ºå¼‚å¸¸
**è§£å†³**: è¿™æ˜¯æ­£å¸¸çš„ã€‚ENUM åœ¨ MySQL ä¸­ä¼šåˆ›å»ºç‰¹æ®Šçš„ç±»å‹ï¼ŒæŸ¥è¯¢æ—¶æ˜¾ç¤ºä¸ºå­—ç¬¦ä¸²ã€‚

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆä¿®å¤åï¼Œè¯·éªŒè¯ï¼š

- [ ] 3ä¸ªæ–°è¡¨éƒ½å·²åˆ›å»ºï¼ˆuser_collections, user_simulations, user_filesï¼‰
- [ ] æ¯ä¸ªè¡¨éƒ½æœ‰æ­£ç¡®çš„ç´¢å¼•
- [ ] å¤–é”®çº¦æŸå·²åˆ›å»ºï¼ˆCASCADE DELETEï¼‰
- [ ] å¯ä»¥æ’å…¥æµ‹è¯•æ•°æ®ï¼ˆè¿è¡Œæµ‹è¯•è„šæœ¬ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥

ä¿®å¤å®Œæˆåï¼Œç»§ç»­æµ‹è¯•ï¼š

```bash
# å¯åŠ¨åç«¯
npm run dev

# è¿è¡Œæµ‹è¯•ï¼ˆæ–°ç»ˆç«¯ï¼‰
node test-content-api.js
```

---

**æ›´æ–°æ—¥æœŸ**: 2025-10-30  
**é—®é¢˜ç±»å‹**: æ•°æ®åº“è¿ç§»é”™è¯¯  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

