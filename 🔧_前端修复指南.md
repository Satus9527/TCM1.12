# 🔧 前端对接修复指南

**前端项目**: czb_test4  
**问题**: 需要修复才能对接后端  
**优先级**: 高

---

## ⚠️ 发现的7个问题

### 问题1: 环境变量缺失 ⭐⭐⭐⭐⭐

**症状**: 无法连接后端API

**修复**: 创建环境变量文件

**操作**:
1. 在 `czb_test4/` 目录下创建 `.env.development`:
```env
VITE_API_BASE_URL=http://localhost:3000/api
```

2. 创建 `.env.production`:
```env
VITE_API_BASE_URL=https://yourdomain.com/api
```

---

### 问题2: Element Plus 引用错误 ⭐⭐⭐⭐⭐

**症状**: 运行时错误，提示找不到 `Message`, `MessageBox`

**原因**: 使用了 Element UI 的语法，但安装的是 Element Plus

**修复**: 修改 `src/utils/request.js`

**当前代码** (错误):
```javascript
import { Message, MessageBox } from 'element-ui';
```

**应该改为** (正确):
```javascript
import { ElMessage, ElMessageBox } from 'element-plus';

// 替换所有使用
Message.error()  →  ElMessage.error()
Message.warning()  →  ElMessage.warning()
Message.success()  →  ElMessage.success()
Message.info()  →  ElMessage.info()
MessageBox.confirm()  →  ElMessageBox.confirm()
```

---

### 问题3: Vuex Mutations 命名不一致 ⭐⭐⭐

**症状**: `AppHeader.vue` 调用 `CLEAR_USER`，但 store 中定义的是 `clearUser`

**修复**: 统一命名

**检查文件**:
- `src/store/index.js` - mutation 定义
- `src/components/Layout/AppHeader.vue` - 调用处

**应该**:
- 要么都用大写: `CLEAR_USER`
- 要么都用驼峰: `clearUser`

**推荐**: 使用大写命名 mutations（Vue官方约定）

---

### 问题4: 模拟登录未连接真实API ⭐⭐⭐⭐⭐

**症状**: 登录使用模拟数据，不调用后端

**修复**: 修改 `src/store/index.js` 和 `src/views/Login.vue`

**当前代码** (模拟):
```javascript
async login({ commit }, credentials) {
    await new Promise(resolve => setTimeout(resolve, 1000));
    // 模拟数据...
}
```

**应该改为** (真实API):
```javascript
async login({ commit }, credentials) {
    const response = await request.post('/auth/login', credentials);
    const { data } = response;
    commit('SET_TOKEN', {
        access_token: data.access_token,
        refresh_token: data.refresh_token
    });
    commit('SET_USER', data.user);
    return response;
}
```

---

### 问题5: Vue版本混用 ⭐⭐⭐

**症状**: `App.vue` 使用 Composition API，但 `Login.vue` 使用 Options API

**影响**: 代码风格不一致

**建议**: 保持一致性，建议全部使用 Composition API

---

### 问题6: 缺少API服务层 ⭐⭐⭐

**症状**: 各页面直接写axios调用

**建议**: 创建 `src/api/` 文件夹

**目录结构**:
```
src/api/
├── auth.js      # 认证相关API
├── medicine.js  # 药材API
├── formula.js   # 方剂API
├── recommendation.js  # 推荐API
└── simulation.js  # 模拟API
```

---

### 问题7: WebSocket未实现 ⭐⭐⭐

**症状**: `src/utils/websocket.js` 存在但未使用

**修复**: 实现WebSocket并集成到Simulation页面

---

## 🚀 快速修复步骤

### 步骤1: 创建环境变量（必须）

```bash
cd czb_test4
echo "VITE_API_BASE_URL=http://localhost:3000/api" > .env.development
echo "VITE_API_BASE_URL=https://yourdomain.com/api" > .env.production
```

---

### 步骤2: 修复Element Plus引用

**文件**: `src/utils/request.js`

**修改内容**:
1. 第2行: `element-ui` → `element-plus`
2. 第2行: `{ Message, MessageBox }` → `{ ElMessage, ElMessageBox }`
3. 第39行: `Message.error` → `ElMessage.error`
4. 第66行: `Message.error` → `ElMessage.error`
5. 第81行: `Message.warning` → `ElMessage.warning`

**全局替换**:
```javascript
// 替换 Message. 为 ElMessage.
// 替换 MessageBox. 为 ElMessageBox.
```

---

### 步骤3: 修复Vuex命名

**文件**: `src/store/index.js`

**修改**:
- 第27行: `CLEAR_USER` → 保持不变
- 第31行: `clearUser` → `CLEAR_USER` (检查并统一)

**文件**: `src/components/Layout/AppHeader.vue`
- 第55行: `CLEAR_USER` → 保持一致

---

### 步骤4: 连接真实登录API

**文件**: `src/store/index.js`

**修改** `login` action:
```javascript
async login({ commit }, credentials) {
    try {
        const request = (await import('@/utils/request')).default;
        const response = await request.post('/auth/login', credentials);
        
        if (response.success) {
            const { access_token, refresh_token, user } = response.data;
            commit('SET_TOKEN', { access_token, refresh_token });
            commit('SET_USER', user);
        }
        return response;
    } catch (error) {
        throw error;
    }
}
```

---

### 步骤5: 修复Login.vue

**文件**: `src/views/Login.vue`

**修改** `handleLogin` 方法:
```javascript
async handleLogin() {
    this.$refs.loginForm.validate(async (valid) => {
        if (valid) {
            this.loading = true;
            try {
                await this.$store.dispatch('login', this.loginForm);
                this.$message.success('登录成功');
                this.$router.push('/');
            } catch (error) {
                this.$message.error('登录失败，请检查用户名和密码');
            } finally {
                this.loading = false;
            }
        }
    });
}
```

**注意**: 需要修复 `$message` 引用（Element Plus）

---

### 步骤6: 修复App.vue中的$message

**文件**: `src/components/Layout/AppHeader.vue`

**修改**:
```javascript
import { ElMessage, ElMessageBox } from 'element-plus'

// 使用
ElMessage.success('已退出登录')
ElMessage.info('个人信息功能开发中')
ElMessageBox.confirm('确定要退出登录吗？', ...)
```

---

## 🧪 测试步骤

### 1. 启动后端

```bash
cd "D:\TCM web"
启动服务器.bat
```

---

### 2. 修复前端后启动

```bash
cd czb_test4
# 创建环境变量文件
echo VITE_API_BASE_URL=http://localhost:3000/api > .env.development

# 安装依赖
npm install

# 启动前端
npm run dev
```

---

### 3. 测试登录

1. 访问 `http://localhost:5173/login`
2. 使用测试账号: `testuser` / `password123`
3. 应该能成功登录

---

## 📝 修复检查清单

- [ ] 创建 `.env.development` 文件
- [ ] 创建 `.env.production` 文件
- [ ] 修复 `src/utils/request.js` 中的 Element Plus 引用
- [ ] 修复所有 `Message` / `MessageBox` 引用
- [ ] 统一 Vuex mutation 命名
- [ ] 修改 login action 连接真实API
- [ ] 修改 Login.vue 使用 store
- [ ] 修复所有组件中的消息提示引用
- [ ] 测试登录功能
- [ ] 测试其他页面

---

## 🎯 完成标准

修复完成后应该：
- ✅ 前端能成功连接后端
- ✅ 登录功能正常工作
- ✅ 能获取真实数据
- ✅ 无运行时错误
- ✅ 所有页面正常显示

---

**预计修复时间**: 1-2小时  
**所需技能**: Vue 3, Element Plus  
**优先级**: P0 (立即修复)

