# 🚀 AI服务快速对接指南

**日期**: 2025年11月2日  
**URL**: https://subsocial-robbyn-uninfinitely.ngrok-free.dev  
**状态**: ⏳ 准备对接

---

## ✅ 已获得的信息

- **AI服务URL**: `https://subsocial-robbyn-uninfinitely.ngrok-free.dev`
- **健康检查**: ✅ 已验证
- **可用端点**: `/health`, `/consult`
- **版本**: 2.0
- **系统**: 仲景中医AI咨询系统

---

## 🔧 立即执行的3个步骤

### 步骤1: 更新 .env 配置 (2分钟)

**编辑 `.env` 文件**:

```env
# 找到以下行并更新:
E1_RECOMMEND_URL=https://subsocial-robbyn-uninfinitely.ngrok-free.dev/consult
E1_ANALYZE_URL=https://subsocial-robbyn-uninfinitely.ngrok-free.dev/consult
E1_HEALTH_URL=https://subsocial-robbyn-uninfinitely.ngrok-free.dev/health

# 确认超时设置:
E1_TIMEOUT_MS=5000  # 或增加至15000（如果首次请求较慢）

# 确认以下行已注释或删除:
# E1_API_KEY=...  # Colab不需要API Key
```

---

### 步骤2: 测试AI服务连接 (1分钟)

**使用curl测试**:

```bash
# 测试1: 健康检查
curl https://subsocial-robbyn-uninfinitely.ngrok-free.dev/health

# 预期响应:
# {
#   "endpoints": {...},
#   "message": "仲景中医AI咨询系统",
#   "status": "运行中",
#   "version": "2.0"
# }

# 测试2: 推荐接口
curl -X POST https://subsocial-robbyn-uninfinitely.ngrok-free.dev/consult \
  -H "Content-Type: application/json" \
  -d '{"question": "我的症状是：发热。请辨证并推荐合适的方剂。"}'
```

---

### 步骤3: 重启后端服务 (1分钟)

```bash
# 如果使用PM2
pm2 restart tcm-backend

# 或直接重启
# 按 Ctrl+C 停止，然后:
npm start
```

---

## 🧪 验证对接成功

### 方法1: 通过后端API测试

```bash
# 1. 登录获取Token
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"health_user","password":"password123"}'

# 2. 使用Token测试推荐
curl -X POST http://localhost:3000/api/recommend/formula \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "symptoms": ["发热", "恶寒"],
    "tongue_desc": "舌淡红苔薄白"
  }'
```

**预期结果**:
- ✅ 返回推荐结果（正常情况）
- ✅ 或返回降级方案（AI服务异常时）

---

### 方法2: 查看日志

**观察后端日志**:

```bash
# PM2日志
pm2 logs tcm-backend

# 或应用日志
tail -f logs/combined.log
```

**关键信息**:
- ✅ 连接AI服务成功
- ✅ 收到AI响应
- ⚠️  超时或降级（可能首次请求慢）

---

## ⚠️ 常见问题

### Q1: 首次请求很慢？

**A**: Colab首次请求可能需要5-15秒，这是正常的。

**解决方案**:
```env
# 增加超时时间
E1_TIMEOUT_MS=15000
```

---

### Q2: 连接失败？

**A**: 检查以下几点:

1. URL是否正确
2. 网络是否能访问ngrok
3. AI服务是否仍在运行

**诊断命令**:
```bash
# 测试网络连接
ping subsocial-robbyn-uninfinitely.ngrok-free.dev

# 测试HTTPS
curl -v https://subsocial-robbyn-uninfinitely.ngrok-free.dev/health
```

---

### Q3: 会话过期？

**A**: Colab会话约12小时有效。

**解决方案**:
- 联系AI团队获取新URL
- 更新 .env 文件
- 重启服务

---

## 📋 对接检查清单

### 配置 ✅

- [x] AI服务URL已获得
- [ ] .env 文件已更新
- [ ] 超时配置已调整
- [ ] API Key已移除

### 测试 ⏳

- [ ] 健康检查测试通过
- [ ] 推荐接口测试通过
- [ ] 分析接口测试通过
- [ ] 降级方案测试通过

### 服务 ⏳

- [ ] 后端服务已重启
- [ ] 日志无错误
- [ ] API响应正常

---

## 📚 详细文档

更多信息请查看:

1. **`🤖_Colab_AI集成指南.md`** - 技术实现细节
2. **`🧪_Colab_AI测试指南.md`** - 完整测试流程
3. **`🎉_AI_Service_URL已获取.md`** - URL获取详情
4. **`test-ai-url.js`** - 自动化测试脚本

---

## ⏰ 预计时间

- 配置更新: 2分钟
- 服务重启: 1分钟
- 测试验证: 5分钟

**总计**: 约10分钟完成对接

---

## 🎯 成功后标志

对接成功的标志:

1. ✅ 健康检查返回正常状态
2. ✅ 推荐接口返回结果
3. ✅ 降级方案在异常时生效
4. ✅ 日志无错误信息

---

## 📞 需要帮助？

**如果遇到问题**:

1. 查看详细文档
2. 检查日志输出
3. 联系AI团队确认服务状态
4. 验证URL有效性

---

**对接时间**: ___________  
**对接负责人**: ___________  
**验证状态**: ⏳ **待执行**

