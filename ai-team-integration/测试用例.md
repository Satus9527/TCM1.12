# 测试用例

**文档版本**: 1.0  
**创建日期**: 2025年11月2日  
**用途**: AI团队验证实现正确性

---

## 📋 测试概览

本文档提供了具体的测试用例，AI团队可以用这些用例验证自己的实现是否符合后端要求。

---

## 🧪 测试用例1: 推荐服务 - 基本用例

### 测试目标

验证AI能正确返回带标记的推荐结果

### 请求

```bash
curl -X POST https://{your-colab-url}/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "我的症状是：发热，恶寒，头痛。舌象是：舌淡红苔薄白。请根据这些信息，辨证并推荐合适的经典方剂ID（格式：辨证为：[证型]。方剂ID：[uuid]。）。"
  }'
```

### 预期响应

```json
{
  "success": true,
  "question": "我的症状是：发热，恶寒，头痛。...",
  "answer": "根据您的症状，辨证为：[风寒束表证]。推荐使用方剂ID：[550e8400-e29b-41d4-a716-446655440000]。此方剂解表散寒，适合当前症状。",
  "processing_time_seconds": 2.34,
  "timestamp": "2025-11-02T09:30:00Z"
}
```

### ✅ 检查点

- [ ] HTTP状态码: 200
- [ ] success字段: true
- [ ] answer包含标记: `辨证为：[xxx]。`
- [ ] answer包含标记: `方剂ID：[yyy]。`
- [ ] 方括号格式正确: `[` 和 `]`
- [ ] 中文标点正确: `：` 和 `。`

---

## 🧪 测试用例2: 推荐服务 - 多种症状

### 测试目标

验证AI能处理复杂症状列表

### 请求

```bash
curl -X POST https://{your-colab-url}/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "我的症状是：口干，口苦，腹胀，便秘。舌象是：舌红苔黄腻。请根据这些信息，辨证并推荐合适的经典方剂ID（格式：辨证为：[证型]。方剂ID：[uuid]。）。"
  }'
```

### 预期响应格式

```json
{
  "success": true,
  "answer": "辨证为：[湿热蕴结证]。方剂ID：[660e8400-e29b-41d4-a716-446655440001]。"
}
```

### ✅ 检查点

- [ ] 能够辨证多种症状
- [ ] 标记格式正确
- [ ] 推荐符合证型

---

## 🧪 测试用例3: 推荐服务 - 无推荐

### 测试目标

验证AI对无法处理的情况返回错误

### 请求

```bash
curl -X POST https://{your-colab-url}/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "我的症状是：无明显症状。请推荐。"
  }'
```

### 预期响应

```json
{
  "success": false,
  "error": "症状信息不足，无法辨证",
  "timestamp": "2025-11-02T09:30:00Z"
}
```

### ✅ 检查点

- [ ] success字段: false
- [ ] 有error字段
- [ ] HTTP状态码可以是200或4xx

---

## 🧪 测试用例4: 分析服务 - 基本用例

### 测试目标

验证AI能正确返回带JSON标记的分析结果

### 请求

```bash
curl -X POST https://{your-colab-url}/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "请分析这个配伍：麻黄 10g，桂枝 10g，甘草 5g。请提供以下信息的JSON格式（用<JSON_START>...</JSON_END>包裹）：{\n  \"overall_properties\": { \"nature\": \"...\", \"flavor\": [...], \"meridian\": [...] },\n  \"functions_analysis\": { \"解表\": 5, \"清热\": 8, ... },\n  \"suggestions\": [...]\n}"
  }'
```

### 预期响应

```json
{
  "success": true,
  "question": "请分析这个配伍：...",
  "answer": "该配伍性温，味辛甘，归肺膀胱经。整体功效以解表为主。<JSON_START>{\"overall_properties\": {\"nature\": \"温\", \"flavor\": [\"辛\", \"甘\"], \"meridian\": [\"肺\", \"膀胱\"]}, \"functions_analysis\": {\"解表\": 8, \"散寒\": 7, \"宣肺\": 6}, \"suggestions\": [\"适用于风寒表证\", \"体虚者慎用\"]}<JSON_END>",
  "processing_time_seconds": 3.45,
  "timestamp": "2025-11-02T09:35:00Z"
}
```

### ✅ 检查点

- [ ] HTTP状态码: 200
- [ ] success字段: true
- [ ] answer包含标记: `<JSON_START>`
- [ ] answer包含标记: `<JSON_END>`
- [ ] JSON标记内的内容是有效JSON
- [ ] JSON包含`overall_properties`
- [ ] JSON包含`functions_analysis`

---

## 🧪 测试用例5: 分析服务 - 复杂配伍

### 测试目标

验证AI能分析包含多味药材的配伍

### 请求

```bash
curl -X POST https://{your-colab-url}/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "请分析这个配伍：人参 10g，白术 10g，茯苓 10g，甘草 5g，当归 10g。请提供以下信息的JSON格式（用<JSON_START>...</JSON_END>包裹）：{\n  \"overall_properties\": { \"nature\": \"...\", \"flavor\": [...], \"meridian\": [...] },\n  \"functions_analysis\": { \"解表\": 5, \"清热\": 8, ... },\n  \"suggestions\": [...]\n}"
  }'
```

### 预期响应格式

```json
{
  "success": true,
  "answer": "...<JSON_START>{\"overall_properties\": {...}, \"functions_analysis\": {\"补气\": 9, \"补脾\": 8, \"养血\": 7}, \"suggestions\": [...]}<JSON_END>"
}
```

### ✅ 检查点

- [ ] JSON格式正确
- [ ] functions_analysis包含多个功效
- [ ] 功效强度合理（1-10）

---

## 🧪 测试用例6: 分析服务 - JSON格式验证

### 测试目标

验证返回的JSON是有效格式

### 请求

```bash
curl -X POST https://{your-colab-url}/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "请分析这个配伍：麻黄 10g。请提供JSON格式。"
  }'
```

### 提取并验证JSON

```python
import json
import re

response = {...}  # 获取响应
answer = response['answer']

# 提取JSON
match = re.search(r'<JSON_START>(.*?)<JSON_END>', answer, re.DOTALL)
if match:
    json_str = match.group(1)
    try:
        data = json.loads(json_str)  # 必须成功
        print("✅ JSON有效")
    except json.JSONDecodeError as e:
        print(f"❌ JSON格式错误: {e}")
```

### ✅ 检查点

- [ ] JSON能成功解析
- [ ] 没有语法错误
- [ ] 数据类型正确

---

## 🧪 测试用例7: 健康检查

### 测试目标

验证服务是否可访问

### 请求

```bash
curl https://{your-colab-url}/health
```

### 预期响应

```json
{
  "status": "ok",
  "timestamp": "2025-11-02T09:00:00Z"
}
```

### ✅ 检查点

- [ ] HTTP状态码: 200
- [ ] 响应迅速（<1秒）

---

## 🧪 测试用例8: 性能测试

### 测试目标

验证响应时间

### 测试方法

```bash
# 记录响应时间
time curl -X POST https://{your-colab-url}/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "我的症状是：发热。请推荐。"
  }'
```

### 预期

- ✅ 首次请求: < 30秒（Colab冷启动）
- ✅ 后续请求: < 5秒（理想）
- ⚠️ 后端超时: 5秒

### ✅ 检查点

- [ ] 响应时间可接受
- [ ] 无明显延迟

---

## 📊 测试结果记录表

| 用例ID | 测试项 | 状态 | 响应时间 | 备注 |
|--------|--------|------|---------|------|
| TC1 | 推荐-基本 | ⬜ | - | |
| TC2 | 推荐-复杂 | ⬜ | - | |
| TC3 | 推荐-错误 | ⬜ | - | |
| TC4 | 分析-基本 | ⬜ | - | |
| TC5 | 分析-复杂 | ⬜ | - | |
| TC6 | 分析-JSON | ⬜ | - | |
| TC7 | 健康检查 | ⬜ | - | |
| TC8 | 性能 | ⬜ | - | |

**说明**: 
- ⬜ 未测试
- ✅ 通过
- ❌ 失败
- ⚠️ 部分通过

---

## 🐛 常见问题排查

### Q1: JSON标记不在response中

**症状**: 后端无法找到`<JSON_START>`标记

**检查**:
1. 检查是否使用了正确的标签名
2. 检查大小写是否匹配
3. 检查是否有空格

### Q2: JSON解析失败

**症状**: `json.loads()`报错

**检查**:
1. JSON是否使用双引号（不是单引号）
2. 是否有尾随逗号
3. 字符串是否需要转义

### Q3: 推荐无标记

**症状**: 没有`辨证为：[xxx]`标记

**检查**:
1. 是否使用中文方括号`[` `]`
2. 是否使用中文标点`:`
3. 格式是否与示例完全一致

---

**测试完成后，请将结果反馈给后端团队！**

