# API 格式规范要求

**文档版本**: 1.0  
**创建日期**: 2025年11月2日  
**项目**: TCM Platform 后端与 Colab AI 对接

---

## 📋 概述

本文档详细说明了后端团队需要的AI服务API格式规范。**这是实现稳定集成的关键**。

AI团队必须严格遵循这些格式约定，否则后端将无法正确解析响应。

---

## 🎯 对接现状

### 服务端点

AI团队已提供Colab服务，使用以下端点：
- `POST /consult` - 统一咨询接口
- `GET /health` - 健康检查

### 认证方式

- **无API Key认证**（Colab方案）
- **允许CORS跨域**

---

## 1️⃣ 推荐服务规范（P4）

### 场景

**用例**: 用户输入症状，AI推荐方剂

**后端URL映射**: `E1_RECOMMEND_URL` → `POST /consult`

### 请求格式

#### 后端发送

```json
{
  "question": "我的症状是：发热，恶寒，头痛。舌象是：舌淡红苔薄白。请根据这些信息，辨证并推荐合适的经典方剂ID（格式：辨证为：[证型]。方剂ID：[uuid]。）。"
}
```

#### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| question | string | 是 | 包含症状、舌象等信息的自然语言问题 |

---

### 响应格式（AI必须返回）

#### ✅ 标准响应

```json
{
  "success": true,
  "question": "我的症状是：发热，恶寒，头痛。...",
  "answer": "根据您的症状，辨证为：[风寒束表证]。推荐使用方剂ID：[550e8400-e29b-41d4-a716-446655440000]。此方剂解表散寒，适合当前症状。",
  "processing_time_seconds": 2.34,
  "timestamp": "2025-11-02T09:30:00Z"
}
```

#### ⚠️ 关键标记（必须包含）

**AI的answer字段中必须包含以下标记**:

```
辨证为：[证型]。方剂ID：[uuid]。
```

**示例**:
```
辨证为：[风寒束表证]。方剂ID：[550e8400-e29b-41d4-a716-446655440000]。
辨证为：[湿热蕴结证]。方剂ID：[660e8400-e29b-41d4-a716-446655440001]。
```

#### ❌ 错误响应

```json
{
  "success": false,
  "question": "...",
  "error": "症状信息不足，无法辨证",
  "timestamp": "2025-11-02T09:30:00Z"
}
```

---

### 格式要求说明

#### 标记格式

**必须使用**:
- 方括号: `[` 和 `]`
- 中文字体标点: `。`（不是英文句号）
- 中文冒号: `：`（不是英文冒号）

**错误示例**:
```
❌ 辨证为:{风寒束表证}.方剂ID:{uuid}.
❌ 辨证为:(风寒束表证),方剂ID:(uuid)
❌ 辨证为：风寒束表证。方剂ID：uuid。 （缺少方括号）
```

#### UUID格式

**推荐**: 标准UUID v4格式

**示例**: `550e8400-e29b-41d4-a716-446655440000`

**允许**: 任何32字符以上的唯一标识符

---

### 降级处理

如果AI返回的answer**不包含标准标记**，后端将：

1. 记录警告日志
2. 使用降级方案
3. 返回`formula_id: "generic-answer-uuid"`
4. 将完整answer作为reasoning返回
5. 前端需要特殊处理

**这会导致功能降级，用户体验下降！**

---

## 2️⃣ 分析服务规范（P5）

### 场景

**用例**: 用户构建配伍，AI分析药性功效

**后端URL映射**: `E1_ANALYZE_URL` → `POST /consult`

### 请求格式

#### 后端发送

```json
{
  "question": "请分析这个配伍：麻黄 10g，桂枝 10g，甘草 5g。请提供以下信息的JSON格式（用<JSON_START>...</JSON_END>包裹）：{\n  \"overall_properties\": { \"nature\": \"...\", \"flavor\": [...], \"meridian\": [...] },\n  \"functions_analysis\": { \"解表\": 5, \"清热\": 8, ... },\n  \"suggestions\": [...]\n}"
}
```

#### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| question | string | 是 | 包含配伍信息的自然语言问题，并要求JSON格式返回 |

---

### 响应格式（AI必须返回）

#### ✅ 标准响应

```json
{
  "success": true,
  "question": "请分析这个配伍：麻黄 10g，桂枝 10g...",
  "answer": "该配伍性温，味辛甘，归肺膀胱经。整体功效以解表为主。<JSON_START>{\"overall_properties\": {\"nature\": \"温\", \"flavor\": [\"辛\", \"甘\"], \"meridian\": [\"肺\", \"膀胱\"]}, \"functions_analysis\": {\"解表\": 8, \"散寒\": 7, \"宣肺\": 6}, \"suggestions\": [\"适用于风寒表证\", \"体虚者慎用\"]}<JSON_END>",
  "processing_time_seconds": 3.45,
  "timestamp": "2025-11-02T09:35:00Z"
}
```

#### ⚠️ 关键标记（必须包含）

**AI的answer字段中必须包含JSON标记**:

```
<JSON_START>{
  "overall_properties": {...},
  "functions_analysis": {...},
  "suggestions": [...]
}<JSON_END>
```

#### JSON结构要求

```json
{
  "overall_properties": {
    "nature": "温",              // 药性：寒/热/温/凉/平
    "flavor": ["辛", "甘"],      // 五味：辛甘酸苦咸
    "meridian": ["肺", "膀胱"]   // 归经
  },
  "functions_analysis": {
    "解表": 8,                   // 功效名称：强度(1-10)
    "散寒": 7,
    "清热": 2
  },
  "suggestions": [
    "适用于风寒表证",
    "体虚者慎用"
  ]
}
```

#### ❌ 错误响应

```json
{
  "success": false,
  "question": "...",
  "error": "配伍信息不完整",
  "timestamp": "2025-11-02T09:35:00Z"
}
```

---

### 格式要求说明

#### JSON标记格式

**必须使用**:
- 标记: `<JSON_START>` 和 `<JSON_END>`（大小写敏感）
- JSON内容: 必须是**有效JSON**，不是JSON字符串

**错误示例**:
```
❌ <json_start>{"key":"value"}<json_end>   (大小写错误)
❌ <JSON_START>"{'key':'value'}"<JSON_END> (引号错误)
❌ JSON: {"key":"value"}                   (无标记)
❌ 整体药性：温...                         (只有文本，无JSON)
```

#### JSON内容

- 必须是标准的JSON格式
- 可以使用换行和空格（推荐）
- 不可以使用单引号或尾随逗号
- 数值必须是数字类型（不是字符串）

---

### 降级处理

如果AI返回的answer**不包含JSON标记**，后端将：

1. 记录警告日志
2. 使用降级方案
3. 返回默认结构：
   ```json
   {
     "overall_properties": {
       "nature": "未知",
       "flavor": ["?"],
       "meridian": ["?"]
     },
     "functions_analysis": {
       "AI原始回答": 10
     },
     "original_text": "完整的AI回答..."
   }
   ```
4. 前端需要特殊处理

**这会导致功能降级，用户体验下降！**

---

## 3️⃣ 健康检查规范

### 端点

`GET /health`

### 响应格式

```json
{
  "status": "ok",
  "timestamp": "2025-11-02T09:00:00Z",
  "version": "1.0.0"
}
```

---

## 4️⃣ 错误处理规范

### 超时处理

**后端超时配置**: 5秒

**建议**: AI首次请求可能较慢，但应尽量控制在5秒内

### 错误响应格式

所有错误都应返回：

```json
{
  "success": false,
  "error": "错误原因描述",
  "timestamp": "2025-11-02T..."
}
```

---

## 5️⃣ 测试接口

### 推荐测试

**请求**:
```bash
curl -X POST https://{your-colab-url}/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "我的症状是：发热，恶寒。请推荐方剂。"
  }'
```

**预期响应**:
```json
{
  "success": true,
  "answer": "辨证为：[风寒束表证]。方剂ID：[550e8400-e29b-41d4-a716-446655440000]。"
}
```

### 分析测试

**请求**:
```bash
curl -X POST https://{your-colab-url}/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "请分析配伍：麻黄 10g，桂枝 10g。"
  }'
```

**预期响应**:
```json
{
  "success": true,
  "answer": "该配伍...<JSON_START>{\"overall_properties\": {\"nature\": \"温\"}, \"functions_analysis\": {\"解表\": 8}}<JSON_END>"
}
```

---

## ⚠️ 关键点总结

### 必须遵循

1. ✅ **推荐**: answer中**必须**包含 `辨证为：[xxx]。方剂ID：[yyy]。`
2. ✅ **分析**: answer中**必须**包含 `<JSON_START>...<JSON_END>`
3. ✅ **标记**: 严格使用指定标记格式（方括号、尖括号等）
4. ✅ **JSON**: 必须是有效的JSON格式

### 不允许

1. ❌ 返回无标记的自然语言答案
2. ❌ 使用错误的标记格式
3. ❌ JSON格式错误
4. ❌ 缺少必需字段

---

## 📝 开发建议

### 对于AI团队

1. **检查格式**: 每次返回前检查标记是否正确
2. **单元测试**: 为格式生成编写测试
3. **日志验证**: 记录每次返回内容便于调试
4. **逐步迭代**: 先保证格式，再优化内容

### 沟通机制

1. **格式确认**: 开发前与后端确认格式理解
2. **测试反馈**: 提供测试URL供后端验证
3. **问题上报**: 发现问题及时沟通

---

## 🆘 支持

如有任何问题，请查看 `联系方式.md` 联系后端团队。

---

**此文档为关键对接规范，请务必严格遵守！**

