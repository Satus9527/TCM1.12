# 🤖 TCM Platform 自动部署说明

**日期**: 2025年11月2日  
**说明**: 关于自动部署的实际情况和替代方案

---

## ⚠️ 重要说明

### 为什么无法直接自动部署？

1. **我需要访问您的服务器**
   - 自动部署需要 SSH 连接
   - 需要服务器 IP、用户名、密码或密钥
   - 存在安全风险

2. **Windows 环境限制**
   - 部署脚本 `deploy.sh` 是 Bash 脚本
   - 需要在 Linux 服务器上执行
   - Windows 本地无法直接运行

3. **安全考虑**
   - 不能存储服务器凭证
   - 需要手动验证权限
   - 建议您亲自执行

---

## ✅ 替代方案

### 方案1: 手动执行部署（推荐）

按照部署指南一步步执行：

```bash
# 在您的 Linux 服务器上

# 1. 登录服务器
ssh user@your-server-ip

# 2. 按照指南执行
# 阅读部署指南
cat 🚀_生产部署指南_无Docker版.md

# 3. 使用我提供的脚本
# 上传文件到服务器后
chmod +x deploy.sh
./deploy.sh
```

---

### 方案2: 使用部署指南

我已经为您创建了完整的部署文档：

**主文档**:
- `🚀_生产部署指南_无Docker版.md` - 完整步骤
- `📖_部署快速参考.md` - 命令速查
- `📚_部署文档索引.md` - 文档导航

**配置文件**:
- `ecosystem.config.js` - PM2 配置
- `nginx-tcm-platform.conf` - Nginx 配置
- `deploy.sh` - 部署脚本

**使用步骤**:

1. **在 Windows 本地准备**:
   ```powershell
   # 查看部署文档
   cat "🚀_生产部署指南_无Docker版.md"
   
   # 将文件上传到服务器
   # 可以使用 scp、WinSCP 或其他工具
   ```

2. **在 Linux 服务器执行**:
   ```bash
   # 按照指南逐步执行
   # 阶段一、二、三、四、五
   ```

---

### 方案3: 半自动部署（推荐）

**Windows 端准备**:

创建一个 PowerShell 脚本辅助上传文件：

```powershell
# deploy-helper.ps1

# 服务器信息
$SERVER_IP = "your-server-ip"
$SERVER_USER = "ubuntu"
$LOCAL_DIR = "."
$REMOTE_DIR = "/var/www/tcm-backend"

Write-Host "准备上传文件到服务器..." -ForegroundColor Yellow

# 使用 scp 上传（需要配置 SSH）
# scp -r .env.example ecosystem.config.js nginx-tcm-platform.conf deploy.sh $SERVER_USER@$SERVER_IP:$REMOTE_DIR

Write-Host "上传完成！" -ForegroundColor Green
Write-Host "请登录服务器执行: cd $REMOTE_DIR && ./deploy.sh" -ForegroundColor Cyan
```

---

## 📋 部署流程概览

### 在服务器上执行的步骤

```bash
# ========================================
# 自动部署流程（在服务器上执行）
# ========================================

# 1. 克隆代码（首次部署）
cd /var/www
sudo git clone YOUR_REPO_URL tcm-backend
cd tcm-backend

# 2. 使用 Node.js 和 npm（已在服务器安装）
nvm use  # 使用项目指定的 Node.js 版本

# 3. 安装依赖
npm install --production

# 4. 配置环境变量
sudo nano .env
# 复制配置内容，修改必要的值

# 5. 数据库迁移
npm run db:migrate
npm run db:seed

# 6. 配置 Nginx
sudo cp nginx-tcm-platform.conf /etc/nginx/sites-available/tcm_platform
sudo ln -s /etc/nginx/sites-available/tcm_platform /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# 7. SSL 证书（需要域名解析）
sudo certbot --nginx -d yourdomain.com

# 8. 配置 PM2
cp ecosystem.config.js .

# 9. 启动服务
pm2 start ecosystem.config.js
pm2 startup
pm2 save

# 10. 验证
curl http://localhost:3000/api/health
```

---

## 🔧 我提供的工具

### 1. 部署脚本

`deploy.sh` - 用于更新代码和重启服务：

```bash
# 在服务器上使用
./deploy.sh
```

**功能**:
- ✅ Git 代码更新
- ✅ 依赖安装
- ✅ 可选数据库迁移
- ✅ PM2 重启
- ✅ 状态检查

---

### 2. PM2 配置

`ecosystem.config.js` - PM2 进程管理：

```bash
# 复制到服务器
cp ecosystem.config.js /var/www/tcm-backend/

# PM2 会自动加载
pm2 start ecosystem.config.js
```

---

### 3. Nginx 配置模板

`nginx-tcm-platform.conf` - 反向代理配置：

```bash
# 复制到服务器并启用
sudo cp nginx-tcm-platform.conf /etc/nginx/sites-available/tcm_platform
sudo ln -s /etc/nginx/sites-available/tcm_platform /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 🎯 推荐做法

### 最佳实践

1. **在 Windows 本地**:
   - ✅ 阅读部署指南
   - ✅ 准备配置文件
   - ✅ 测试和验证代码

2. **在 Linux 服务器**:
   - ✅ 按照指南执行
   - ✅ 使用提供的脚本
   - ✅ 验证部署结果

3. **后续更新**:
   - ✅ 使用 `deploy.sh` 快速更新
   - ✅ 查看日志监控状态
   - ✅ 定期备份

---

## 📚 相关文档

1. **完整部署指南**: `🚀_生产部署指南_无Docker版.md`
2. **快速参考**: `📖_部署快速参考.md`
3. **文档索引**: `📚_部署文档索引.md`
4. **Docker 说明**: `📦_Docker使用情况报告.md`

---

## 🤔 常见问题

### Q1: 我可以在 Windows 上自动部署吗？

**A**: 不能。部署需要在 Linux 服务器上执行。Windows 上可以：
- 阅读部署指南
- 准备配置文件
- 上传文件到服务器

---

### Q2: 能否帮我远程部署？

**A**: 不建议。原因：
- 安全风险（需要凭证）
- 权限问题
- 网络限制

**建议**: 按照详细指南手动执行，或在指导下操作。

---

### Q3: 部署脚本如何使用？

**A**: 
```bash
# 1. 上传 deploy.sh 到服务器
# 2. 添加执行权限
chmod +x deploy.sh

# 3. 在项目目录执行
cd /var/www/tcm-backend
./deploy.sh
```

---

### Q4: 我需要 SSH 访问服务器吗？

**A**: 是的。自动部署需要：
- SSH 访问权限
- sudo 权限
- Git 仓库访问

---

## ✅ 总结

### 实际情况

- ❌ 无法在 Windows 上直接自动部署
- ❌ 无法远程访问您的服务器
- ✅ 已提供完整的部署指南
- ✅ 已提供所有配置文件
- ✅ 已提供自动化脚本

### 推荐流程

1. **现在**（Windows）: 阅读部署指南，准备文件
2. **部署时**（Linux）: 按照指南执行，使用提供的脚本
3. **后续**（Linux）: 使用 `deploy.sh` 快速更新

---

**🎯 最重要的是**: 我为您准备了完整的工具和文档，您只需要在服务器上按照步骤执行即可！

---

**创建日期**: 2025年11月2日  
**状态**: 文档和工具已就绪

