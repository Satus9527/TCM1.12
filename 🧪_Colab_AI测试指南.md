# ğŸ§ª Colab AI é›†æˆæµ‹è¯•æŒ‡å—

**æ—¥æœŸ**: 2025å¹´11æœˆ2æ—¥  
**ç›®æ ‡**: éªŒè¯åç«¯ä¸Colab AIæœåŠ¡çš„å®Œæ•´é›†æˆ

---

## ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡

### 1. ç¯å¢ƒå˜é‡é…ç½®

**æ–‡ä»¶**: `.env`

```env
# AI Service (E1) - Colab äº‘ç«¯æœåŠ¡
E1_RECOMMEND_URL=https://{AIå›¢é˜Ÿæä¾›çš„public_url}/consult
E1_ANALYZE_URL=https://{AIå›¢é˜Ÿæä¾›çš„public_url}/consult
E1_HEALTH_URL=https://{AIå›¢é˜Ÿæä¾›çš„public_url}/health

# SLA è¶…æ—¶é…ç½®
E1_TIMEOUT_MS=5000

# æ³¨æ„: å·²ç§»é™¤ E1_API_KEYï¼ˆColabä¸ä½¿ç”¨ï¼‰
```

**é‡è¦**: æ›¿æ¢ `{AIå›¢é˜Ÿæä¾›çš„public_url}` ä¸ºå®é™…çš„Colab URL

---

### 2. é‡å¯æœåŠ¡

```bash
# å¦‚æœä½¿ç”¨PM2
pm2 restart tcm-backend

# æˆ–ç›´æ¥é‡å¯
npm start
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### ç”¨ä¾‹1: AIå¥åº·æ£€æŸ¥ âœ…

**ç›®æ ‡**: éªŒè¯ColabæœåŠ¡æ˜¯å¦å¯è®¿é—®

**å‘½ä»¤**:
```bash
curl https://{public_url}/health
```

**é¢„æœŸ**:
```json
{
  "status": "ok",
  "timestamp": "2025-11-02T..."
}
```

**å¦‚æœå¤±è´¥**: 
- âŒ æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®
- âŒ æ£€æŸ¥Colabä¼šè¯æ˜¯å¦è¿‡æœŸï¼ˆ12å°æ—¶é™åˆ¶ï¼‰
- âŒ è”ç³»AIå›¢é˜Ÿè·å–æœ€æ–°URL

---

### ç”¨ä¾‹2: P4æ¨è - æˆåŠŸè§£æ âœ…

**ç›®æ ‡**: éªŒè¯æ¨èæ¥å£åºåˆ—åŒ–å’Œè§£æ

**å‡†å¤‡**:
```bash
# 1. è·å–ç™»å½•Token
export TOKEN=$(curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"health_user","password":"password123"}' \
  | jq -r '.data.access_token')
```

**è¯·æ±‚**:
```bash
curl -X POST http://localhost:3000/api/recommend/formula \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "symptoms": ["å‘çƒ­", "æ¶å¯’", "å¤´ç—›"],
    "tongue_desc": "èˆŒæ·¡çº¢è‹”è–„ç™½"
  }'
```

**é¢„æœŸ**:
```json
{
  "success": true,
  "data": {
    "recommendations": [{
      "formula": {
        "id": "uuid-formula-xxx",
        "name": "éº»é»„æ±¤",
        ...
      },
      "ai_analysis": {
        "reasoning": "é£å¯’æŸè¡¨è¯",
        "confidence": 0.7,
        ...
      },
      "safety_check": {...}
    }],
    "total": 1
  }
}
```

**æ£€æŸ¥ç‚¹**:
- âœ… è¯·æ±‚å‘é€æˆåŠŸ
- âœ… AIè¿”å›åŒ…å«"æ–¹å‰‚IDï¼š[uuid]"æ ‡è®°
- âœ… åç«¯è§£æå‡ºformula_id
- âœ… è¿”å›æ–¹å‰‚è¯¦æƒ…

---

### ç”¨ä¾‹3: P4æ¨è - æ— æ³•è§£æï¼ˆé™çº§æ–¹æ¡ˆï¼‰âš ï¸

**åœºæ™¯**: AIè¿”å›æ— æ ‡è®°çš„è‡ªç„¶è¯­è¨€

**è¯·æ±‚**: åŒä¸Š

**é¢„æœŸ**:
```json
{
  "success": true,
  "data": {
    "recommendations": [{
      "formula": {...},
      "ai_analysis": {
        "reasoning": "å®Œæ•´AIå›ç­”æ–‡æœ¬...",
        ...
      },
      ...
    }],
    ...
  }
}
```

**æ£€æŸ¥ç‚¹**:
- âš ï¸ formula_id = 'generic-answer-uuid'
- âš ï¸ reasoning = å®Œæ•´AIåŸå§‹å›ç­”
- âš ï¸ å‰ç«¯éœ€è¦ç‰¹æ®Šå¤„ç†

**æ—¥å¿—æ£€æŸ¥**:
```bash
pm2 logs tcm-backend | grep "æ— æ³•ä»AIç­”æ¡ˆä¸­è§£ææ–¹å‰‚ID"
```

---

### ç”¨ä¾‹4: P4æ¨è - è¶…æ—¶æµ‹è¯• â±ï¸

**ç›®æ ‡**: éªŒè¯5ç§’è¶…æ—¶æœºåˆ¶

**åœºæ™¯**: Colabé¦–æ¬¡è¯·æ±‚æˆ–ä¼šè¯è¿‡æœŸ

**é¢„æœŸ**:
```json
{
  "timestamp": "2025-11-02T...",
  "status": 503,
  "error": "Service Unavailable",
  "message": "AIæ¨èæœåŠ¡å“åº”è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•",
  "error_code": "AI_SERVICE_UNAVAILABLE",
  "path": "/api/recommend/formula"
}
```

**æ£€æŸ¥ç‚¹**:
- âœ… 503çŠ¶æ€ç 
- âœ… error_code = "AI_SERVICE_UNAVAILABLE"
- âœ… ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯

**æ—¥å¿—æ£€æŸ¥**:
```bash
pm2 logs tcm-backend | grep "E1æœåŠ¡è°ƒç”¨è¶…æ—¶"
```

---

### ç”¨ä¾‹5: P5åˆ†æ - WebSocketæˆåŠŸ âœ…

**å‡†å¤‡**:
```bash
# 1. è·å–WebSocketç¥¨æ®
export TICKET=$(curl -X POST http://localhost:3000/api/auth/ws-ticket \
  -H "Authorization: Bearer $TOKEN" \
  | jq -r '.data.ticket')
```

**è¯·æ±‚**: ä½¿ç”¨WebSocketå®¢æˆ·ç«¯è¿æ¥

**å‘é€æ¶ˆæ¯**:
```json
{
  "type": "UPDATE_COMPOSITION",
  "payload": {
    "medicine_id": "med-001",
    "name": "éº»é»„",
    "dosage": "10g"
  }
}
```

**é¢„æœŸæ¨é€**:
```json
{
  "type": "AI_ANALYSIS_RESULT",
  "payload": {
    "overall_properties": {
      "nature": "æ¸©",
      "flavor": ["è¾›", "å¾®è‹¦"],
      "meridian": ["è‚º", "è†€èƒ±"]
    },
    "functions_analysis": {
      "è§£è¡¨": 8,
      "æ•£å¯’": 7
    },
    ...
  },
  "timestamp": "2025-11-02T..."
}
```

**æ£€æŸ¥ç‚¹**:
- âœ… å»æŠ–300msç”Ÿæ•ˆ
- âœ… AIè¿”å›åŒ…å«`<JSON_START>...</JSON_END>`
- âœ… åç«¯è§£æJSONæˆåŠŸ
- âœ… WebSocketæ¨é€ç»“æœ

---

### ç”¨ä¾‹6: P5åˆ†æ - æ— æ³•è§£æJSONï¼ˆé™çº§æ–¹æ¡ˆï¼‰âš ï¸

**åœºæ™¯**: AIè¿”å›æ— JSONæ ‡è®°

**é¢„æœŸæ¨é€**:
```json
{
  "type": "AI_ANALYSIS_RESULT",
  "payload": {
    "overall_properties": {
      "nature": "æœªçŸ¥",
      "flavor": ["?"],
      "meridian": ["?"]
    },
    "functions_analysis": {
      "AIåŸå§‹å›ç­”": 10  // ç‰¹æ®Šæ ‡è®°
    },
    "original_text": "å®Œæ•´çš„AIå›ç­”æ–‡æœ¬..."
  },
  "timestamp": "2025-11-02T..."
}
```

**æ£€æŸ¥ç‚¹**:
- âš ï¸ functions_analysisåŒ…å«'AIåŸå§‹å›ç­”'
- âš ï¸ é™„å¸¦original_text
- âš ï¸ å‰ç«¯éœ€è¦ç‰¹æ®Šå¤„ç†

---

### ç”¨ä¾‹7: P5åˆ†æ - è¿æ¥å¤±è´¥ âš ï¸

**åœºæ™¯**: Colabä¼šè¯è¿‡æœŸæˆ–URLå¤±æ•ˆ

**é¢„æœŸæ¨é€**:
```json
{
  "type": "AI_ANALYSIS_ERROR",
  "payload": {
    "message": "AIæœåŠ¡è¿æ¥å¤±è´¥",
    "code": "ECONNREFUSED"
  },
  "timestamp": "2025-11-02T..."
}
```

**æ£€æŸ¥ç‚¹**:
- âœ… æ¨é€é”™è¯¯æ¶ˆæ¯
- âœ… é”™è¯¯ä»£ç å‡†ç¡®
- âœ… ç”¨æˆ·ä½“éªŒå‹å¥½

---

### ç”¨ä¾‹8: P5åˆ†æ - è¶…æ—¶ â±ï¸

**åœºæ™¯**: AIå¤„ç†æ—¶é—´è¶…è¿‡10ç§’

**é¢„æœŸæ¨é€**:
```json
{
  "type": "AI_ANALYSIS_ERROR",
  "payload": {
    "message": "AIåˆ†æè¶…æ—¶ï¼Œè¯·ç¨åå†è¯•",
    "code": "ECONNABORTED"
  },
  "timestamp": "2025-11-02T..."
}
```

**æ£€æŸ¥ç‚¹**:
- âœ… è¶…æ—¶å¤„ç†æ­£ç¡®
- âœ… æ¸…ç†èµ„æº
- âœ… ä¸é˜»å¡åç»­è¯·æ±‚

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æŒ‡æ ‡1: P4å“åº”æ—¶é—´

**æµ‹è¯•**:
```bash
for i in {1..5}; do
  echo "æµ‹è¯• $i:"
  time curl -X POST http://localhost:3000/api/recommend/formula \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $TOKEN" \
    -d '{"symptoms":["å¤´ç—›"]}' \
    -w "\næ€»æ—¶é—´: %{time_total}s\n"
done
```

**é¢„æœŸ**:
- âœ… å¤§éƒ¨åˆ†è¯·æ±‚ < 5ç§’
- âš ï¸ é¦–æ¬¡è¯·æ±‚å¯èƒ½ > 5ç§’ï¼ˆColabå†·å¯åŠ¨ï¼‰

**æ”¹è¿›å»ºè®®**: å¦‚æœé¦–æ¬¡è¯·æ±‚è¶…æ—¶ç‡é«˜ï¼Œè€ƒè™‘å¢åŠ è¶…æ—¶åˆ°15ç§’

---

### æŒ‡æ ‡2: P5å“åº”æ—¶é—´

**æµ‹è¯•**: é€šè¿‡WebSocketç›‘æ§

**é¢„æœŸ**:
- âœ… å¤§éƒ¨åˆ†è¯·æ±‚ < 10ç§’
- âš ï¸ é¦–æ¬¡è¯·æ±‚å¯èƒ½æ›´é•¿

---

## ğŸ” æ—¥å¿—æ£€æŸ¥

### å…³é”®æ—¥å¿—æœç´¢

```bash
# æŸ¥çœ‹æ‰€æœ‰AIè°ƒç”¨æ—¥å¿—
pm2 logs tcm-backend | grep "E1"

# æŸ¥çœ‹æˆåŠŸè§£æ
pm2 logs tcm-backend | grep "æˆåŠŸè§£æAI"

# æŸ¥çœ‹é™çº§æ–¹æ¡ˆ
pm2 logs tcm-backend | grep "é™çº§æ–¹æ¡ˆ"

# æŸ¥çœ‹è¶…æ—¶
pm2 logs tcm-backend | grep "è¶…æ—¶"

# æŸ¥çœ‹è¿æ¥å¤±è´¥
pm2 logs tcm-backend | grep "è¿æ¥å¤±è´¥"
```

---

### æ—¥å¿—æ ¼å¼ç¤ºä¾‹

**æˆåŠŸ**:
```
[INFO] æˆåŠŸè§£æAIæ¨èç»“æœ { correlationId: 'xxx', formula_id: 'uuid-xxx' }
```

**é™çº§**:
```
[WARN] æ— æ³•ä»AIç­”æ¡ˆä¸­è§£ææ–¹å‰‚IDï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ { correlationId: 'xxx' }
```

**è¶…æ—¶**:
```
[ERROR] E1æœåŠ¡è°ƒç”¨è¶…æ—¶ { correlationId: 'xxx', timeout: 5000 }
```

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŠŸèƒ½æµ‹è¯•
- [ ] å¥åº·æ£€æŸ¥æˆåŠŸ
- [ ] P4æ¨èæˆåŠŸè§£æ
- [ ] P4æ¨èé™çº§æ–¹æ¡ˆ
- [ ] P4è¶…æ—¶å¤„ç†
- [ ] P5åˆ†ææˆåŠŸè§£æ
- [ ] P5åˆ†æé™çº§æ–¹æ¡ˆ
- [ ] P5è¶…æ—¶å¤„ç†
- [ ] P5è¿æ¥å¤±è´¥å¤„ç†

### æ€§èƒ½æµ‹è¯•
- [ ] P4å¤§éƒ¨åˆ†è¯·æ±‚ < 5ç§’
- [ ] P5å¤§éƒ¨åˆ†è¯·æ±‚ < 10ç§’
- [ ] é¦–æ¬¡è¯·æ±‚è¶…æ—¶ç‡ < 50%

### æ—¥å¿—æ£€æŸ¥
- [ ] æ‰€æœ‰å…³é”®æ“ä½œæœ‰æ—¥å¿—
- [ ] é™çº§æ–¹æ¡ˆæ—¥å¿—æ¸…æ™°
- [ ] é”™è¯¯æ—¥å¿—å®Œæ•´
- [ ] æ— å¼‚å¸¸é”™è¯¯å †æ ˆ

---

## ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: è¯·æ±‚è¶…æ—¶

**ç—‡çŠ¶**: P4/P5è¶…æ—¶é¢‘ç¹

**æ’æŸ¥**:
1. æ£€æŸ¥ColabæœåŠ¡æ˜¯å¦æ­£å¸¸
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„è¶…æ—¶è¯¦ç»†ä¿¡æ¯

**è§£å†³**:
- å¢åŠ è¶…æ—¶æ—¶é—´åˆ°15ç§’ï¼ˆä¸´æ—¶ï¼‰
- è”ç³»AIå›¢é˜Ÿä¼˜åŒ–å“åº”é€Ÿåº¦

---

### Q2: è§£æå¤±è´¥ç‡é«˜

**ç—‡çŠ¶**: é™çº§æ–¹æ¡ˆé¢‘ç¹è§¦å‘

**æ’æŸ¥**:
1. æŸ¥çœ‹æ—¥å¿—ä¸­çš„answeré¢„è§ˆ
2. æ£€æŸ¥AIè¿”å›æ ¼å¼æ˜¯å¦å˜åŒ–

**è§£å†³**:
- ä¸AIå›¢é˜Ÿç¡®è®¤è¿”å›æ ¼å¼è§„èŒƒ
- ä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼
- è°ƒæ•´é™çº§ç­–ç•¥

---

### Q3: æ— æ³•è¿æ¥

**ç—‡çŠ¶**: ECONNREFUSEDæˆ–ENOTFOUND

**æ’æŸ¥**:
1. æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
3. ç¡®è®¤Colabä¼šè¯æœªè¿‡æœŸ

**è§£å†³**:
- æ›´æ–°`.env`ä¸­çš„URL
- è”ç³»AIå›¢é˜Ÿè·å–æœ€æ–°åœ°å€

---

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```markdown
# Colab AIé›†æˆæµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: YYYY-MM-DD
**æµ‹è¯•äººå‘˜**: XXX
**Colab URL**: https://xxx.ngrok.io

## æµ‹è¯•ç»“æœ

### åŠŸèƒ½æµ‹è¯•
- [ ] P4æ¨èæˆåŠŸ: X/10
- [ ] P4é™çº§: X/10
- [ ] P4è¶…æ—¶: X/10
- [ ] P5åˆ†ææˆåŠŸ: X/10
- [ ] P5é™çº§: X/10
- [ ] P5è¶…æ—¶: X/10

### æ€§èƒ½æµ‹è¯•
- P4å¹³å‡å“åº”: X.Xç§’
- P4é¦–æ¬¡è¯·æ±‚: X.Xç§’
- P5å¹³å‡å“åº”: X.Xç§’
- P5é¦–æ¬¡è¯·æ±‚: X.Xç§’

### é—®é¢˜æ±‡æ€»
1. ...
2. ...

### å»ºè®®
1. ...
2. ...
```

---

**æµ‹è¯•å®Œæˆåï¼Œè¯·è®°å½•ç»“æœå¹¶åé¦ˆç»™å›¢é˜Ÿï¼**

